{% extends 'base.html' %}
{% block title %}Result - Order Availability Checker{% endblock %}

{% block head_extra %}
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
    <style>
      /* Dark theme fixes for result page */
      [data-bs-theme="dark"] .text-dark {
        color: var(--text-primary) !important;
      }
      
      [data-bs-theme="dark"] .text-muted {
        color: var(--text-secondary) !important;
      }
      
      [data-bs-theme="dark"] .table {
        background-color: var(--card-bg);
        color: var(--text-primary);
      }
      
      [data-bs-theme="dark"] .table th,
      [data-bs-theme="dark"] .table td {
        background-color: var(--card-bg);
        color: var(--text-primary);
        border-color: var(--border-color);
      }
      
      /* Remove striped table styling to let status colors show */
      
      [data-bs-theme="dark"] .alert {
        background-color: var(--bg-secondary);
        border-color: var(--border-color);
        color: var(--text-primary);
      }
      
      [data-bs-theme="dark"] .form-control,
      [data-bs-theme="dark"] .form-select {
        background-color: var(--bg-secondary);
        border-color: var(--border-color);
        color: var(--text-primary);
      }
      
      [data-bs-theme="dark"] .form-control:focus,
      [data-bs-theme="dark"] .form-select:focus {
        background-color: var(--bg-secondary);
        border-color: #2563eb;
        color: var(--text-primary);
        box-shadow: 0 0 0 0.25rem rgba(37, 99, 235, 0.25);
      }
      
      [data-bs-theme="dark"] .btn-outline-secondary {
        color: var(--text-secondary);
        border-color: var(--border-color);
      }
      
      [data-bs-theme="dark"] .btn-outline-secondary:hover {
        color: var(--text-primary);
        background-color: var(--bg-secondary);
        border-color: var(--border-color);
      }
      
      [data-bs-theme="dark"] .dropdown-menu {
        background-color: var(--card-bg);
        border-color: var(--border-color);
      }
      
      [data-bs-theme="dark"] .dropdown-item {
        color: var(--text-primary);
      }
      
      [data-bs-theme="dark"] .dropdown-item:hover {
        background-color: var(--bg-secondary);
        color: var(--text-primary);
      }
      
      /* Remove base table row colors to let status colors show */
      
      /* Fix table text visibility in dark mode */
      [data-bs-theme="dark"] .table tbody tr td {
        color: var(--text-primary) !important;
        background-color: var(--card-bg) !important;
      }
      
      [data-bs-theme="dark"] .table thead tr th {
        color: var(--text-primary) !important;
        background-color: var(--bg-secondary) !important;
      }
      
      [data-bs-theme="dark"] .break-anywhere {
        color: var(--text-primary) !important;
      }
      
      [data-bs-theme="dark"] .text-end {
        color: var(--text-primary) !important;
      }
      
      /* Full View Table Row Colors */
      .table tbody tr.status-full {
        background-color: rgba(40, 167, 69, 0.1) !important;
        border-left: 4px solid #28a745;
      }
      
      .table tbody tr.status-not-full {
        background-color: rgba(255, 193, 7, 0.1) !important;
        border-left: 4px solid #ffc107;
      }
      
      .table tbody tr.status-not-have {
        background-color: rgba(220, 53, 69, 0.1) !important;
        border-left: 4px solid #dc3545;
      }
      
      /* Dark theme row colors */
      [data-bs-theme="dark"] .table tbody tr.status-full {
        background-color: rgba(40, 167, 69, 0.2) !important;
        border-left: 4px solid #5cbf5c;
      }
      
      [data-bs-theme="dark"] .table tbody tr.status-not-full {
        background-color: rgba(255, 193, 7, 0.2) !important;
        border-left: 4px solid #ffd43b;
      }
      
      [data-bs-theme="dark"] .table tbody tr.status-not-have {
        background-color: rgba(220, 53, 69, 0.2) !important;
        border-left: 4px solid #e74c3c;
      }
      
      /* Hover effects for full view table */
      .table tbody tr.status-full:hover {
        background-color: rgba(40, 167, 69, 0.2) !important;
      }
      
      .table tbody tr.status-not-full:hover {
        background-color: rgba(255, 193, 7, 0.2) !important;
      }
      
      .table tbody tr.status-not-have:hover {
        background-color: rgba(220, 53, 69, 0.2) !important;
      }
      
      /* Dark theme hover effects */
      [data-bs-theme="dark"] .table tbody tr.status-full:hover {
        background-color: rgba(40, 167, 69, 0.3) !important;
      }
      
      [data-bs-theme="dark"] .table tbody tr.status-not-full:hover {
        background-color: rgba(255, 193, 7, 0.3) !important;
      }
      
      [data-bs-theme="dark"] .table tbody tr.status-not-have:hover {
        background-color: rgba(220, 53, 69, 0.3) !important;
      }
      
      /* Full Table View Dark Mode Fixes */
      [data-bs-theme="dark"] .modal-content {
        background-color: var(--card-bg);
        color: var(--text-primary);
      }
      
      [data-bs-theme="dark"] .modal-header {
        background-color: var(--card-bg);
        border-bottom-color: var(--border-color);
      }
      
      [data-bs-theme="dark"] .modal-title {
        color: var(--text-primary);
      }
      
      /* Full table search section dark mode */
      [data-bs-theme="dark"] .bg-light {
        background-color: var(--bg-secondary) !important;
        border-bottom-color: var(--border-color) !important;
      }
      
      /* Full table dark mode styling */
      [data-bs-theme="dark"] #fullProcessingTable {
        background-color: var(--card-bg);
        color: var(--text-primary);
      }
      
      [data-bs-theme="dark"] #fullProcessingTable thead th {
        background-color: var(--bg-secondary) !important;
        color: var(--text-primary) !important;
        border-color: var(--border-color) !important;
      }
      
      [data-bs-theme="dark"] #fullProcessingTable tbody td {
        color: var(--text-primary) !important;
        border-color: var(--border-color) !important;
      }
      
      /* Default background for cells without status */
      [data-bs-theme="dark"] #fullProcessingTable tbody tr:not(.status-full):not(.status-not-full):not(.status-not-have) td {
        background-color: var(--card-bg) !important;
      }
      
      /* Override table-dark class in dark mode */
      [data-bs-theme="dark"] .table-dark {
        background-color: var(--bg-secondary) !important;
        color: var(--text-primary) !important;
      }
      
      [data-bs-theme="dark"] .table-dark th {
        background-color: var(--bg-secondary) !important;
        color: var(--text-primary) !important;
        border-color: var(--border-color) !important;
      }
      
      /* Full table row status colors in dark mode - subtle visibility */
      [data-bs-theme="dark"] #fullProcessingTable tbody tr.status-full {
        background-color: rgba(40, 167, 69, 0.15) !important;
        border-left: 3px solid #4ade80;
      }
      
      [data-bs-theme="dark"] #fullProcessingTable tbody tr.status-full td {
        background-color: rgba(40, 167, 69, 0.15) !important;
      }
      
      [data-bs-theme="dark"] #fullProcessingTable tbody tr.status-not-full {
        background-color: rgba(255, 193, 7, 0.15) !important;
        border-left: 3px solid #fbbf24;
      }
      
      [data-bs-theme="dark"] #fullProcessingTable tbody tr.status-not-full td {
        background-color: rgba(255, 193, 7, 0.15) !important;
      }
      
      [data-bs-theme="dark"] #fullProcessingTable tbody tr.status-not-have {
        background-color: rgba(220, 53, 69, 0.15) !important;
        border-left: 3px solid #f87171;
      }
      
      [data-bs-theme="dark"] #fullProcessingTable tbody tr.status-not-have td {
        background-color: rgba(220, 53, 69, 0.15) !important;
      }
      
      /* Full table hover effects in dark mode - subtle enhancement */
      [data-bs-theme="dark"] #fullProcessingTable tbody tr.status-full:hover {
        background-color: rgba(40, 167, 69, 0.25) !important;
      }
      
      [data-bs-theme="dark"] #fullProcessingTable tbody tr.status-full:hover td {
        background-color: rgba(40, 167, 69, 0.25) !important;
      }
      
      [data-bs-theme="dark"] #fullProcessingTable tbody tr.status-not-full:hover {
        background-color: rgba(255, 193, 7, 0.25) !important;
      }
      
      [data-bs-theme="dark"] #fullProcessingTable tbody tr.status-not-full:hover td {
        background-color: rgba(255, 193, 7, 0.25) !important;
      }
      
      [data-bs-theme="dark"] #fullProcessingTable tbody tr.status-not-have:hover {
        background-color: rgba(220, 53, 69, 0.25) !important;
      }
      
      [data-bs-theme="dark"] #fullProcessingTable tbody tr.status-not-have:hover td {
        background-color: rgba(220, 53, 69, 0.25) !important;
      }
      
      /* Fix text-danger class in dark mode */
      [data-bs-theme="dark"] .text-danger {
        color: #ff6b6b !important;
      }
      
      /* Fix badge colors in dark mode */
      [data-bs-theme="dark"] .badge.bg-primary {
        background-color: #2563eb !important;
        color: white !important;
      }
      
      [data-bs-theme="dark"] .badge.bg-success {
        background-color: #16a34a !important;
        color: white !important;
      }
      
      [data-bs-theme="dark"] .badge.bg-warning {
        background-color: #eab308 !important;
        color: #000 !important;
      }
      
      [data-bs-theme="dark"] .badge.bg-secondary {
        background-color: #6b7280 !important;
        color: white !important;
      }
    </style>
{% endblock %}

{% block content %}
    <div class="container py-5">
      <!-- Header Section -->
      <div class="row align-items-center mb-4">
        <div class="col-md-8">
          {% if is_historical %}
          <h1 class="display-6 fw-bold text-gradient mb-2">
            <i class="bi bi-clock-history me-2"></i>Saved Processing Results
          </h1>
          {% else %}
          <h1 class="display-6 fw-bold text-gradient mb-2">Processing Results</h1>
          {% endif %}
          <div class="d-flex flex-wrap gap-3 align-items-center">
            <div class="d-flex align-items-center">
              <i class="bi bi-database text-primary me-2"></i>
              <span class="text-muted">Stock: <strong class="text-dark">{{ stock_name }}</strong></span>
            </div>
            <div class="d-flex align-items-center">
              <i class="bi bi-cart text-success me-2"></i>
              <span class="text-muted">Order: <strong class="text-dark">{{ order_name }}</strong></span>
            </div>
            {% if is_historical %}
            <div class="d-flex align-items-center">
              <span class="badge bg-info text-white">
                <i class="bi bi-archive me-1"></i>Historical Data
              </span>
            </div>
            {% endif %}
          </div>
        </div>
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
          <div class="d-flex flex-column flex-md-row gap-2 justify-content-md-end">
            <a class="btn btn-outline-secondary" href="{{ url_for('index') }}">
              <i class="bi bi-arrow-left me-2"></i>{% if is_historical %}Back to Home{% else %}Process Another{% endif %}
            </a>
            <button class="btn btn-outline-primary" onclick="openFullTableView()">
              <i class="bi bi-arrows-fullscreen me-2"></i>Full View
            </button>
            {% if download_token %}
            <div class="dropdown">
              <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="bi bi-download me-2"></i>Download
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="{{ url_for('download_excel', token=download_token) }}">
                  <i class="bi bi-file-earmark-spreadsheet me-2"></i>Excel File
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('download_pdf', token=download_token) }}">
                  <i class="bi bi-file-earmark-pdf me-2"></i>PDF Report
                </a></li>
              </ul>
            </div>
            {% else %}
            <div class="text-muted small">
              <i class="bi bi-info-circle me-1"></i>Downloads not available for historical data
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Statistics Cards -->
      <div class="row g-4 mb-5">
        <div class="col-6 col-lg-3">
          <div class="stat-card bg-primary text-white">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="label">Total Items</div>
              <i class="bi bi-box display-6 opacity-25"></i>
            </div>
            <div class="value">{{ summary.total_items }}</div>
            <div class="small d-flex align-items-center">
              <i class="bi bi-weight me-1"></i>
              Total: {{ summary.total_kg_all }} KG
            </div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="stat-card bg-success text-white">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="label">Available</div>
              <i class="bi bi-check-circle display-6 opacity-25"></i>
            </div>
            <div class="value">{{ summary.full }}</div>
            <div class="small d-flex align-items-center">
              <i class="bi bi-weight me-1"></i>
              Ready: {{ summary.total_kg_full }} KG
            </div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="stat-card bg-warning text-dark">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="label">Not Full</div>
              <i class="bi bi-exclamation-triangle display-6 opacity-25"></i>
            </div>
            <div class="value">{{ summary.not_full }}</div>
            <div class="small d-flex align-items-center">
              <i class="bi bi-weight me-1"></i>
              Limited: {{ summary.total_kg_not_full }} KG
            </div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="stat-card bg-secondary text-white">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="label">Not have</div>
              <i class="bi bi-x-circle display-6 opacity-25"></i>
            </div>
            <div class="value">{{ summary.not_have }}</div>
            <div class="small d-flex align-items-center">
              <i class="bi bi-weight me-1"></i>
              Missing: {{ summary.total_kg_not_have }} KG
            </div>
          </div>
        </div>
      </div>

      <!-- Filter Tabs -->
      <div class="d-flex justify-content-between align-items-center mb-2">
        <ul class="nav nav-pills" id="statusTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active d-flex align-items-center" id="tab-all" data-bs-toggle="pill" data-bs-target="#pane-all" type="button" role="tab">
              <i class="bi bi-list-ul me-2"></i>All Items
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link d-flex align-items-center" id="tab-full" data-bs-toggle="pill" data-bs-target="#pane-full" type="button" role="tab">
              <i class="bi bi-check-circle me-2"></i>Available
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link d-flex align-items-center" id="tab-notfull" data-bs-toggle="pill" data-bs-target="#pane-notfull" type="button" role="tab">
              <i class="bi bi-exclamation-triangle me-2"></i>Not Full
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link d-flex align-items-center" id="tab-nothave" data-bs-toggle="pill" data-bs-target="#pane-nothave" type="button" role="tab">
              <i class="bi bi-x-circle me-2"></i>Not have
            </button>
          </li>
        </ul>
        
        <!-- Search and Filter Controls -->
        <div class="d-flex gap-2">
          <div class="input-group input-group-sm" style="max-width: 250px;">
            <span class="input-group-text">
              <i class="bi bi-search"></i>
            </span>
            <input type="text" class="form-control" placeholder="Search items..." id="table-search">
          </div>
        </div>
      </div>

      <!-- Advanced toggle -->
      <div class="d-flex justify-content-end mb-3">
        <button class="btn btn-outline-dark btn-sm" id="toggleAdvanced">Advance Table</button>
      </div>

      <!-- Simple table (default) -->
      <div id="simpleTable">
        <div class="card shadow-sm border-0 rounded-4 mb-4">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-compact align-middle m-0">
                <thead class="table-light">
                  <tr>
                    <th>Order Name</th>
                    <th>Fish Name</th>
                    <th>Packed Size</th>
                    <th class="text-end">Order CTN</th>
                    <th class="text-end">Order KG/CTN</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in records %}
                  <tr class="status-{{ r.status|lower|replace(' ', '-') }}">
                    <td>
                      {% set order_code = order_name.split('_')[1] if order_name.count('_') >= 2 else order_name.split('.')[0] %}
                      <span class="badge bg-primary text-white">{{ order_code }}</span>
                    </td>
                    <td>{{ r['fish_name'] }}</td>
                    <td>{{ r['packed_size'] }}</td>
                    <td class="text-end">{{ r.order_carton }}</td>
                    <td class="text-end">{{ r.order_kg_per_ctn }}</td>
                    <td>
                      {% if r.status == 'Full' %}
                        <span class="badge bg-success">Full</span>
                      {% elif r.status == 'Not Full' %}
                        <span class="badge bg-warning text-dark">Not Full</span>
                      {% else %}
                        <span class="badge bg-secondary">Not have</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Advanced table (hidden by default) -->
      <div id="advancedTable" class="d-none">
      <div class="tab-content">
        <div class="tab-pane fade show active" id="pane-all" role="tabpanel">
          <div class="card shadow-sm border-0 rounded-4 mb-4">
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-compact align-middle m-0">
              <thead class="table-light">
                <tr>
                  <th>Order Name</th>
                  <th>Fish Name</th>
                  <th>Packed Size</th>
                  <th class="text-end">Order CTN</th>
                  <th class="text-end">Stock CTN</th>
                  <th class="text-end">Order KG/CTN</th>
                  <th class="text-end">Stock KG/CTN</th>
                  <th class="text-end">Balance Stock CTN</th>
                   <th class="text-end">MC To Give</th>
                   <th class="text-end">Can Fulfill</th>
                  <th class="text-end">Shortfall</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                {% for r in records %}
                <tr class="status-{{ r.status|lower|replace(' ', '-') }}">
                  <td>
                    {% set order_code = order_name.split('_')[1] if order_name.count('_') >= 2 else order_name.split('.')[0] %}
                    <span class="badge bg-primary text-white">{{ order_code }}</span>
                  </td>
                  <td>{{ r['fish_name'] }}</td>
                  <td>{{ r['packed_size'] }}</td>
                  <td class="text-end">{{ r.order_carton }}</td>
                  <td class="text-end">{{ r.stock_carton }}</td>
                  <td class="text-end">{{ r.order_kg_per_ctn }}</td>
                  <td class="text-end">{{ r.stock_kg_per_ctn }}</td>
                  <td class="text-end">{{ r.balance_stock_carton }}</td>
                  <td class="text-end">{{ r.mc_to_give }}</td>
                  <td class="text-end">{{ r.can_fulfill_carton }}</td>
                  <td class="text-end">{{ r.shortfall }}</td>
                  <td>
                    {% if r.status == 'Full' %}
                      <span class="badge bg-success">Full</span>
                    {% elif r.status == 'Not Full' %}
                      <span class="badge bg-warning text-dark">Not Full</span>
                    {% else %}
                      <span class="badge bg-secondary">Not have</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        {% for label in ['Full','Not Full','Not have'] %}
        <div class="tab-pane fade" id="pane-{{ label|lower|replace(' ', '') }}" role="tabpanel">
          <div class="card shadow-sm border-0 rounded-4 mb-4">
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-compact align-middle m-0">
                  <thead class="table-light">
                    <tr>
                      <th>Order Name</th>
                      <th>Fish Name</th>
                      <th>Packed Size</th>
                      <th class="text-end" data-full-text="Order CTN" data-mobile-text="O.CTN">Order CTN</th>
                      <th class="text-end" data-full-text="Stock CTN" data-mobile-text="S.CTN">Stock CTN</th>
                      <th class="text-end" data-full-text="Order KG/CTN" data-mobile-text="O.KG">Order KG/CTN</th>
                      <th class="text-end" data-full-text="Stock KG/CTN" data-mobile-text="S.KG">Stock KG/CTN</th>
                      <th class="text-end" data-full-text="Balance Stock CTN" data-mobile-text="BAL">Balance Stock CTN</th>
                      <th class="text-end" data-full-text="MC To Give" data-mobile-text="MC">MC To Give</th>
                      <th class="text-end" data-full-text="Can Fulfill" data-mobile-text="CAN">Can Fulfill</th>
                      <th class="text-end" data-full-text="Shortfall" data-mobile-text="SHORT">Shortfall</th>
                      <th data-full-text="Status" data-mobile-text="ST">Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for r in records if r.status == label %}
                    <tr class="status-{{ r.status|lower|replace(' ', '-') }}">
                      <td>
                        {% set order_code = order_name.split('_')[1] if order_name.count('_') >= 2 else order_name.split('.')[0] %}
                        <span class="badge bg-primary text-white">{{ order_code }}</span>
                      </td>
                      <td>{{ r['fish_name'] }}</td>
                      <td>{{ r['packed_size'] }}</td>
                      <td class="text-end">{{ r.order_carton }}</td>
                      <td class="text-end">{{ r.stock_carton }}</td>
                      <td class="text-end">{{ r.order_kg_per_ctn }}</td>
                      <td class="text-end">{{ r.stock_kg_per_ctn }}</td>
                      <td class="text-end">{{ r.balance_stock_carton }}</td>
                      <td class="text-end">{{ r.mc_to_give }}</td>
                      <td class="text-end">{{ r.can_fulfill_carton }}</td>
                      <td class="text-end">{{ r.shortfall }}</td>
                      <td>
                        {% if r.status == 'Full' %}
                          <span class="badge bg-success">Full</span>
                        {% elif r.status == 'Not Full' %}
                          <span class="badge bg-warning text-dark">Not Full</span>
                        {% else %}
                          <span class="badge bg-secondary">Not have</span>
                        {% endif %}
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      </div>

    </div>

<!-- Full Table View Modal -->
<div class="modal fade" id="fullTableModal" tabindex="-1" aria-labelledby="fullTableModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="fullTableModalLabel">
          <i class="bi bi-table me-2"></i>
          Processing Results - Full View
        </h5>
        <div class="d-flex align-items-center gap-3">
          <span class="badge bg-primary" id="fullTableItemCount">{{ records|length }} items</span>
          <button type="button" class="btn btn-outline-success btn-sm" onclick="exportTableToCSV()">
            <i class="bi bi-download me-1"></i>
            Export CSV
          </button>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
      </div>
      <div class="modal-body p-0">
        <!-- Enhanced Search and Filters -->
        <div class="bg-light p-3 border-bottom">
          <div class="row g-3">
            <div class="col-md-3">
              <div class="input-group">
                <span class="input-group-text">
                  <i class="bi bi-search"></i>
                </span>
                <input type="text" class="form-control" id="fullTableSearch" placeholder="Search all columns...">
                <button class="btn btn-outline-secondary" type="button" id="clearFullSearch">
                  <i class="bi bi-x"></i>
                </button>
              </div>
            </div>
            <div class="col-md-2">
              <select class="form-select" id="orderCodeFilter">
                <option value="">All Order Codes</option>
              </select>
            </div>
            <div class="col-md-2">
              <select class="form-select" id="statusFilter">
                <option value="">All Status</option>
                <option value="Full">Full</option>
                <option value="Not Full">Not Full</option>
                <option value="Not have">Not have</option>
              </select>
            </div>
            <div class="col-md-3">
              <select class="form-select" id="fishFilter">
                <option value="">All Fish Types</option>
              </select>
            </div>
            <div class="col-md-2">
              <button class="btn btn-outline-primary w-100" onclick="resetFilters()">
                <i class="bi bi-arrow-clockwise me-1"></i>
                Reset
              </button>
            </div>
          </div>
          <div class="row mt-2">
            <div class="col-md-6">
              <small class="text-muted" id="fullTableSearchResults">Showing all {{ records|length }} results</small>
            </div>
            <div class="col-md-6 text-end">
              <small class="text-muted">
                <i class="bi bi-info-circle me-1"></i>
                Scroll horizontally to see all columns
              </small>
            </div>
          </div>
        </div>

        <!-- Enhanced Table -->
        <div class="table-responsive" style="height: calc(100vh - 200px); overflow: auto;">
          <table class="table table-hover" id="fullProcessingTable">
            <thead class="table-light sticky-top">
              <tr>
                <th style="min-width: 100px;">Order Name</th>
                <th style="min-width: 150px;">Fish Name</th>
                <th style="min-width: 120px;">Packed Size</th>
                <th style="min-width: 100px;">Order CTN</th>
                <th style="min-width: 100px;">Stock CTN</th>
                <th style="min-width: 100px;">Order KG/CTN</th>
                <th style="min-width: 100px;">Stock KG/CTN</th>
                <th style="min-width: 100px;">Balance Stock CTN</th>
                <th style="min-width: 100px;">MC To Give</th>
                <th style="min-width: 100px;">Can Fulfill</th>
                <th style="min-width: 100px;">Shortfall</th>
                <th style="min-width: 100px;">Total Order KG</th>
                <th style="min-width: 100px;">Total Stock KG</th>
                <th style="min-width: 100px;">Can Fulfill KG</th>
                <th style="min-width: 100px;">Shortfall KG</th>
                <th style="min-width: 120px;">Status</th>
              </tr>
            </thead>
            <tbody id="fullTableBody">
              <!-- Data will be populated by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
    <script>
      // Enhanced table search functionality
      (() => {
        const simple = document.getElementById('simpleTable');
        const advanced = document.getElementById('advancedTable');
        const toggleBtn = document.getElementById('toggleAdvanced');

        // Helper: filter simple table by active status tab
        function applyStatusFilterToSimple(activeKey) {
          if (!simple) return;
          const rows = simple.querySelectorAll('tbody tr');
          rows.forEach(row => {
            row.style.display = '';
          });
          if (activeKey === 'all') return;
          const classMap = {
            full: 'status-full',
            notfull: 'status-not-full',
            nothave: 'status-not-have',
          };
          const want = classMap[activeKey];
          rows.forEach(row => {
            const has = row.classList.contains(want);
            row.style.display = has ? '' : 'none';
          });
        }

        // Determine current active tab key
        function getActiveKey() {
          const activeBtn = document.querySelector('#statusTabs .nav-link.active');
          if (!activeBtn) return 'all';
          if (activeBtn.id === 'tab-full') return 'full';
          if (activeBtn.id === 'tab-notfull') return 'notfull';
          if (activeBtn.id === 'tab-nothave') return 'nothave';
          return 'all';
        }
        if (toggleBtn && simple && advanced) {
          function setAdvancedButton(active) {
            if (active) {
              toggleBtn.classList.add('active');
              toggleBtn.classList.remove('btn-outline-dark');
              toggleBtn.classList.add('btn-primary');
              toggleBtn.innerHTML = '<i class="bi bi-toggle-on me-2"></i>Advance Table';
              toggleBtn.setAttribute('aria-pressed', 'true');
            } else {
              toggleBtn.classList.remove('active');
              toggleBtn.classList.add('btn-outline-dark');
              toggleBtn.classList.remove('btn-primary');
              toggleBtn.innerHTML = '<i class="bi bi-toggle-off me-2"></i>Advance Table';
              toggleBtn.setAttribute('aria-pressed', 'false');
            }
          }
          // Always start with simple table visible
          simple.classList.remove('d-none');
          advanced.classList.add('d-none');
          toggleBtn.addEventListener('click', () => {
            const advancedVisible = !advanced.classList.contains('d-none');
            if (advancedVisible) {
              // show simple
              advanced.classList.add('d-none');
              simple.classList.remove('d-none');
              applyStatusFilterToSimple(getActiveKey());
              setAdvancedButton(false);
            } else {
              // show advanced
              simple.classList.add('d-none');
              advanced.classList.remove('d-none');
              setAdvancedButton(true);
            }
          });
          // Initial filter for simple
          applyStatusFilterToSimple(getActiveKey());
          setAdvancedButton(false);
        }

        const searchInput = document.getElementById('table-search');
        
        if (searchInput) {
          searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const container = simple && !simple.classList.contains('d-none') ? simple : advanced;
            const bodies = container.querySelectorAll('.table tbody');
            bodies.forEach(tbody => {
              const rows = tbody.querySelectorAll('tr');
              rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                  row.style.display = '';
                } else {
                  row.style.display = 'none';
                }
              });
            });
          });
        }
        
        // Add smooth animations to cards
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add('animate-in');
            }
          });
        });
        
        document.querySelectorAll('.stat-card, .card').forEach(el => {
          observer.observe(el);
        });
        
        // React to status tab changes to filter simple table
        document.getElementById('statusTabs')?.addEventListener('shown.bs.tab', (ev) => {
          if (!simple || simple.classList.contains('d-none')) return;
          applyStatusFilterToSimple(getActiveKey());
        });

        // Removed table row hover effects for better mobile experience
      })();

      // Full Table View Functions - Global scope for onclick handlers
      let fullTableData = [];
      let filteredFullTableData = [];

      // Make functions globally accessible
      window.openFullTableView = function() {
        // Populate the full table with current data
        populateFullTable();
        
        // Populate filter dropdowns
        populateOrderCodeFilter();
        populateFishFilter();
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('fullTableModal'));
        modal.show();
      }

      window.populateFullTable = function() {
        const tbody = document.getElementById('fullTableBody');
        
        // Get current results from the template data
        const currentResults = {{ records | tojson }};
        fullTableData = currentResults;
        filteredFullTableData = [...fullTableData];
        
        tbody.innerHTML = '';
        
        if (!fullTableData || fullTableData.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="16" class="text-center text-muted py-4">
                <i class="bi bi-table fs-1 mb-3"></i>
                <p>No processing results available.</p>
                <small>This might be because no results were generated.</small>
              </td>
            </tr>
          `;
          return;
        }

        fullTableData.forEach(result => {
          const orderKg = (result.order_carton || 0) * (result.order_kg_per_ctn || 1);
          const stockKg = (result.stock_carton || 0) * (result.stock_kg_per_ctn || 1);
          const canFulfillKg = (result.can_fulfill_carton || 0) * (result.order_kg_per_ctn || 1);
          const shortfallKg = ((result.order_carton || 0) - (result.can_fulfill_carton || 0)) * (result.order_kg_per_ctn || 1);

          // Extract order code from order_name (same logic as batch details)
          const orderName = '{{ order_name }}';
          const orderCode = orderName.split('_').length >= 3 ? 
            orderName.split('_')[1] : 
            orderName.split('.')[0];

          const statusClass = result.status ? `status-${result.status.toLowerCase().replace(' ', '-')}` : '';
          const row = `
            <tr class="${statusClass}">
              <td>
                <span class="badge bg-primary text-white">${orderCode}</span>
              </td>
              <td><strong>${result.fish_name || 'N/A'}</strong></td>
              <td>${result.packed_size || 'N/A'}</td>
              <td class="text-end">${result.order_carton || 0}</td>
              <td class="text-end">${result.stock_carton || 0}</td>
              <td class="text-end">${result.order_kg_per_ctn || 0}</td>
              <td class="text-end">${result.stock_kg_per_ctn || 0}</td>
              <td class="text-end">${result.balance_stock_carton || 0}</td>
              <td class="text-end">${result.mc_to_give || 0}</td>
              <td class="text-end"><strong>${result.can_fulfill_carton || 0}</strong></td>
              <td class="text-end text-danger"><strong>${result.shortfall || 0}</strong></td>
              <td class="text-end">${formatNumber(orderKg)}</td>
              <td class="text-end">${formatNumber(stockKg)}</td>
              <td class="text-end"><strong>${formatNumber(canFulfillKg)}</strong></td>
              <td class="text-end text-danger"><strong>${formatNumber(shortfallKg)}</strong></td>
              <td>${getStatusBadge(result.status)}</td>
            </tr>
          `;
          tbody.innerHTML += row;
        });

        // Update item count
        document.getElementById('fullTableItemCount').textContent = `${fullTableData.length} items`;
        document.getElementById('fullTableSearchResults').textContent = `Showing all ${fullTableData.length} results`;
      }

      window.populateFishFilter = function() {
        const fishFilter = document.getElementById('fishFilter');
        const uniqueFish = [...new Set(fullTableData.map(result => result.fish_name).filter(name => name))];
        
        // Clear existing options except the first one
        fishFilter.innerHTML = '<option value="">All Fish Types</option>';
        
        uniqueFish.sort().forEach(fish => {
          const option = document.createElement('option');
          option.value = fish;
          option.textContent = fish;
          fishFilter.appendChild(option);
        });
      }

      window.populateOrderCodeFilter = function() {
        const orderCodeFilter = document.getElementById('orderCodeFilter');
        const orderName = '{{ order_name }}';
        
        // Extract unique order codes from the data
        const uniqueOrderCodes = [...new Set(fullTableData.map(result => {
          const orderCode = orderName.split('_').length >= 3 ? 
            orderName.split('_')[1] : 
            orderName.split('.')[0];
          return orderCode;
        }).filter(code => code))];
        
        // Clear existing options except the first one
        orderCodeFilter.innerHTML = '<option value="">All Order Codes</option>';
        
        uniqueOrderCodes.sort().forEach(orderCode => {
          const option = document.createElement('option');
          option.value = orderCode;
          option.textContent = orderCode;
          orderCodeFilter.appendChild(option);
        });
      }

      window.filterFullTable = function() {
        const searchTerm = document.getElementById('fullTableSearch').value.toLowerCase().trim();
        const orderCodeFilter = document.getElementById('orderCodeFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;
        const fishFilter = document.getElementById('fishFilter').value;
        
        filteredFullTableData = fullTableData.filter(result => {
          // Search filter
          const searchMatch = !searchTerm || 
            result.fish_name?.toLowerCase().includes(searchTerm) ||
            result.packed_size?.toLowerCase().includes(searchTerm);
          
          // Order Code filter
          const orderName = '{{ order_name }}';
          const orderCode = orderName.split('_').length >= 3 ? 
            orderName.split('_')[1] : 
            orderName.split('.')[0];
          const orderCodeMatch = !orderCodeFilter || orderCode === orderCodeFilter;
          
          // Status filter
          const statusMatch = !statusFilter || result.status === statusFilter;
          
          // Fish filter
          const fishMatch = !fishFilter || result.fish_name === fishFilter;
          
          return searchMatch && orderCodeMatch && statusMatch && fishMatch;
        });
        
        // Update table display
        updateFullTableDisplay();
        
        // Update search results text
        document.getElementById('fullTableSearchResults').textContent = 
          `Showing ${filteredFullTableData.length} of ${fullTableData.length} results`;
      }

      window.updateFullTableDisplay = function() {
        const tbody = document.getElementById('fullTableBody');
        
        tbody.innerHTML = '';
        
        if (filteredFullTableData.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="16" class="text-center text-muted py-4">
                <i class="bi bi-search fs-1 mb-3"></i>
                <p>No results match your filters.</p>
                <small>Try adjusting your search criteria.</small>
              </td>
            </tr>
          `;
          return;
        }

        filteredFullTableData.forEach(result => {
          const orderKg = (result.order_carton || 0) * (result.order_kg_per_ctn || 1);
          const stockKg = (result.stock_carton || 0) * (result.stock_kg_per_ctn || 1);
          const canFulfillKg = (result.can_fulfill_carton || 0) * (result.order_kg_per_ctn || 1);
          const shortfallKg = ((result.order_carton || 0) - (result.can_fulfill_carton || 0)) * (result.order_kg_per_ctn || 1);

          // Extract order code from order_name (same logic as batch details)
          const orderName = '{{ order_name }}';
          const orderCode = orderName.split('_').length >= 3 ? 
            orderName.split('_')[1] : 
            orderName.split('.')[0];

          const statusClass = result.status ? `status-${result.status.toLowerCase().replace(' ', '-')}` : '';
          const row = `
            <tr class="${statusClass}">
              <td>
                <span class="badge bg-primary text-white">${orderCode}</span>
              </td>
              <td><strong>${result.fish_name || 'N/A'}</strong></td>
              <td>${result.packed_size || 'N/A'}</td>
              <td class="text-end">${result.order_carton || 0}</td>
              <td class="text-end">${result.stock_carton || 0}</td>
              <td class="text-end">${result.order_kg_per_ctn || 0}</td>
              <td class="text-end">${result.stock_kg_per_ctn || 0}</td>
              <td class="text-end">${result.balance_stock_carton || 0}</td>
              <td class="text-end">${result.mc_to_give || 0}</td>
              <td class="text-end"><strong>${result.can_fulfill_carton || 0}</strong></td>
              <td class="text-end text-danger"><strong>${result.shortfall || 0}</strong></td>
              <td class="text-end">${formatNumber(orderKg)}</td>
              <td class="text-end">${formatNumber(stockKg)}</td>
              <td class="text-end"><strong>${formatNumber(canFulfillKg)}</strong></td>
              <td class="text-end text-danger"><strong>${formatNumber(shortfallKg)}</strong></td>
              <td>${getStatusBadge(result.status)}</td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      }

      window.resetFilters = function() {
        document.getElementById('fullTableSearch').value = '';
        document.getElementById('orderCodeFilter').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('fishFilter').value = '';
        filteredFullTableData = [...fullTableData];
        updateFullTableDisplay();
        document.getElementById('fullTableSearchResults').textContent = `Showing all ${fullTableData.length} results`;
      }

      window.exportTableToCSV = function() {
        const data = filteredFullTableData.length > 0 ? filteredFullTableData : fullTableData;
        
        if (!data || data.length === 0) {
          alert('No data to export');
          return;
        }

        let csvContent = 'Order Name,Fish Name,Packed Size,Order CTN,Stock CTN,Order KG/CTN,Stock KG/CTN,Balance Stock CTN,MC To Give,Can Fulfill,Shortfall,Total Order KG,Total Stock KG,Can Fulfill KG,Shortfall KG,Status\n';
        
        // Add data rows
        data.forEach(result => {
          const orderKg = (result.order_carton || 0) * (result.order_kg_per_ctn || 1);
          const stockKg = (result.stock_carton || 0) * (result.stock_kg_per_ctn || 1);
          const canFulfillKg = (result.can_fulfill_carton || 0) * (result.order_kg_per_ctn || 1);
          const shortfallKg = ((result.order_carton || 0) - (result.can_fulfill_carton || 0)) * (result.order_kg_per_ctn || 1);
          
          // Extract order code from order_name (same logic as batch details)
          const orderName = '{{ order_name }}';
          const orderCode = orderName.split('_').length >= 3 ? 
            orderName.split('_')[1] : 
            orderName.split('.')[0];
          
          csvContent += `"${orderCode}","${result.fish_name || 'N/A'}","${result.packed_size || 'N/A'}",${result.order_carton || 0},${result.stock_carton || 0},${result.order_kg_per_ctn || 0},${result.stock_kg_per_ctn || 0},${result.balance_stock_carton || 0},${result.mc_to_give || 0},${result.can_fulfill_carton || 0},${result.shortfall || 0},${formatNumber(orderKg)},${formatNumber(stockKg)},${formatNumber(canFulfillKg)},${formatNumber(shortfallKg)},"${result.status || 'N/A'}"\n`;
        });
        
        // Download CSV
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `processing_results_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      // Helper functions
      window.formatNumber = function(value) {
        return parseFloat(value).toFixed(1);
      }

      window.getStatusBadge = function(status) {
        if (status === 'Full') {
          return `<span class="badge bg-success">Full</span>`;
        } else if (status === 'Not Full') {
          return `<span class="badge bg-warning text-dark">Not Full</span>`;
        } else {
          return `<span class="badge bg-secondary">Not have</span>`;
        }
      }

      // Event listeners for full table functionality
      document.addEventListener('DOMContentLoaded', function() {
        // Full table search
        const fullTableSearch = document.getElementById('fullTableSearch');
        if (fullTableSearch) {
          fullTableSearch.addEventListener('input', filterFullTable);
        }
        
        // Clear full search
        const clearFullSearch = document.getElementById('clearFullSearch');
        if (clearFullSearch) {
          clearFullSearch.addEventListener('click', function() {
            document.getElementById('fullTableSearch').value = '';
            filterFullTable();
            document.getElementById('fullTableSearch').focus();
          });
        }
        
        // Order Code filter
        const orderCodeFilter = document.getElementById('orderCodeFilter');
        if (orderCodeFilter) {
          orderCodeFilter.addEventListener('change', filterFullTable);
        }
        
        // Status filter
        const statusFilter = document.getElementById('statusFilter');
        if (statusFilter) {
          statusFilter.addEventListener('change', filterFullTable);
        }
        
        // Fish filter
        const fishFilter = document.getElementById('fishFilter');
        if (fishFilter) {
          fishFilter.addEventListener('change', filterFullTable);
        }
      });
    </script>
{% endblock %}


